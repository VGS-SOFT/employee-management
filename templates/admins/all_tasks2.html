{% extends 'base.html' %}

{% block title %}
  Tasks
{% endblock %}

{% block content %}
  <section class="section">
    <div class="row">
      <div class="col-lg-12">
        <div class="card">
          <div class="card-body">
            {% if messages %}
              <div class="mt-2">
                {% for message in messages %}
                  <div class="alert {% if message.tags %}
                      alert-{{ message.tags }}
                    {% else %}
                      alert-info
                    {% endif %} alert-dismissible fade show"
                    role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                  </div>
                {% endfor %}
              </div>
            {% endif %}

            <div class="card-body d-flex justify-content-between align-items-center">
              <h5 class="card-title">Tasks</h5>
              <a href="{% url 'add_tasks' %}" class="btn btn-primary"><i class="bi bi-plus-circle"></i> Add Tasks</a>
            </div>

            <!-- DataTable -->
            <div>
              {% if data %}
                <table id="projectsTable" class="table table-striped table-bordered">
                  <thead>
                    <tr>
                      <th>Sr. No.</th>
                      <th>Name</th>
                      <th>Description</th>
                      <th>Project</th>
                      <th>Module</th>
                      <th>Status</th>
                      <th>Assigned To</th>
                      <th>Created By</th>
                      <th>Created On</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% if data %}
                      {% for task in data %}
                        <tr>
                          <td>{{ forloop.counter }}</td>
                          <td>{{ task.name }}</td>
                          <td>
                            <div class="description-preview" style="cursor: pointer" onclick="toggleDescription(this)">
                              <span class="short-description">{{ task.description|default:'No description available'|truncatechars:20 }}</span>
                              <span class="full-description" style="display: none">{{ task.description|default:'No description available' }}</span>
                            </div>
                          </td>
                          <td>{{ task.project.name|default:'N/A' }}</td>
                          <td>{{ task.module.name|default:'N/A' }}</td>
                          <td>
                            <span class="badge {% if task.status.name == 'Completed' %}bg-success
                              {% elif task.status.name == 'In Progress' %}bg-warning
                              {% else %}bg-secondary{% endif %}">
                              {{ task.status.name }}
                            </span>
                          </td>
                          <td>{{ task.assigned_to.all|join:', '|default:'N/A' }}</td>
                          <td>{{ task.created_by|default:'Unknown' }}</td>
                          <td>{{ task.created_on|date:'Y-m-d H:i' }}</td>
                          <td>
                            <div class="btn-group" role="group">
                              <a href="{% url 'admin_task_details' task.id %}" class="btn btn-sm btn-info" title="View Details">
                                <i class="bi bi-eye"></i>
                              </a>
                              <a href="{% url 'edit_task' task.id %}" class="btn btn-sm btn-primary" title="Edit Task">
                                <i class="bi bi-pencil"></i>
                              </a>
                              <a href="{% url 'delete_task' task.id %}" class="btn btn-sm btn-danger delete-btn" title="Delete Task">
                                <i class="bi bi-trash"></i>
                              </a>
                            </div>
                          </td> 
                        </tr>
                      {% endfor %}
                    {% else %}
                      <tr>
                        <td colspan="10" class="text-center">No tasks available</td>
                      </tr>
                    {% endif %}
                  </tbody>
                </table>
              {% else %}
                <p class="text-center">No data to display.</p>
              {% endif %}
            </div>
            <!-- End DataTable -->
          </div>
        </div>
      </div>
    </div>
  </section>
{% endblock %}

{% block script %}
  <!-- DataTables CSS and JS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

  <script>
    $(document).ready(function () {
      $('.delete-btn').click(function (event) {
        event.preventDefault()
        const isConfirmed = confirm('Are you sure you want to delete?')
        if (isConfirmed) {
          window.location.href = $(this).attr('href')
        }
      })
    
      $('#projectsTable').DataTable({
        paging: true,
        searching: true,
        ordering: true,
        info: true
      })
    })
    
    function toggleDescription(element) {
      const shortDesc = element.querySelector('.short-description')
      const fullDesc = element.querySelector('.full-description')
    
      if (fullDesc.style.display === 'none') {
        shortDesc.style.display = 'none'
        fullDesc.style.display = 'inline'
      } else {
        shortDesc.style.display = 'inline'
        fullDesc.style.display = 'none'
      }
    }
  </script>
{% endblock %}
